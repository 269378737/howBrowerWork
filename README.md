浏览器的工作原理：新式网络浏览器幕后揭秘
===================================

## 序言

这是一篇全面介绍Webkit和Gecko内部操作的入门文章，是以色列开发人员塔利·加希尔大量研究的成果。在过去的几年中，她查阅了所有公开发布的关于浏览器内部机制的数据（详见[资料](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#Resources)），并花了很多时间来研读网络浏览器的源代码。她写道：

> 在IE占据90%市场份额的年代，我们除了把浏览器当成一个“黑箱”，什么也做不了。但是现在，开放源代码的浏览器拥有了过半的市场份额，因此，是时候来揭开神秘的面纱，一谈网络浏览器的内幕了。额，里面只有数以百万计的C++代码...

塔利在她的[网站](http://taligarsiel.com/)上公布了自己的研究成果，但是我们觉得它值得让更多的人来了解，所以我们在此重新整理并公布。

作为一名网络开发人员，学习浏览器的内部功罪原理将有助于您做出更明智的决策，并理解那些最佳开发时间的个中缘由。尽管这是一篇相当长的文档，但是我们建议您花些事件来仔细阅读；读完之后，您肯定会觉得所费不虚。

## 简洁

网络浏览器很可能是使用最广的软件。在这篇入门文章中，我将会介绍他们的幕后工作原理。我们会了解到，从您在地址栏输入google.com直到您在浏览器屏幕上看到Google首页的整个过程中都发生了什么。

## 我们要讨论的浏览器

目前使用的主流浏览器有五个：Internet Explorer、 Firefox、 Safari、 Chrome浏览器和Opera。本文中以开放源代码浏览器为例，目前Firefox、 Chrome浏览器和Safari（部分开源）。根据[StatCounter浏览器统计数据](http://gs.statcounter.com/)，目前Firefox、 Safari和Chrome浏览器的总市场占有率将近60%。由此可见，如今开放源代码浏览器在浏览器市场中战绝非常监事的部分。

## 浏览器的主要功能

浏览器的主要功能就是向服务器发送请求，在浏览器窗口中展示您选择的网络资源。这里所说的资源一般是指HTML文档，也可以是PDF、图片或其他的类型。资源的位置由用户的URL（统一资源标识符）指定。

浏览器解释并显示HTML文档的方式是在HTML和CSS规范中指定的。这些规范由网络标准化组织`W3C`（万维网联盟）进行维护。

多年以来，各个浏览器都没有完全遵循这些规范，同时还在开发自己独有的扩展程序，这给昂罗开发人员带来了严重的兼容性问题。如今，大多数浏览器都算是或多或少地遵从规范。

浏览器的用户界面有很多彼此相同的元素，其中包括：

*	用来输入URL的地址栏
*	前进和后退按钮
*	数钱设置选项
*	用于刷新和停止加载当前文档的刷新和停止按钮
*	用于返回主页的主页按钮

奇怪的是，浏览的用户界面并没有任何真实规范，这是多年的最佳实践自然发展以及批次之间相互模仿的结果。HTML5也没有定义浏览器必须具备的用户界面元素，但列出了一些通用的元素，例如地址栏，状态栏和工具栏等。当然，各个浏览器也可以有自己独特的功能，比如Firefox的下载管理器。

## 浏览器的高层结构

浏览器的主要组件为：

1.	用户界面-包括地址栏、前进、后退按钮，数钱菜单等。除了浏览器主窗口显示您请求的页面外，其他显示的各个部分都属于用户界面。
2.	浏览器殷勤-用户界面和呈现引擎之间传送命令。
3.	呈现引擎-负责显示请求的内容。如果请求的内容是HTML，它就负责解析HTML和CSS内容，并将解析后的内容显示在屏幕上。
4.	网络-用户网络调用，比如http请求。其接口与平台无关，并为所有平台提供底层实现。
5.	用户界面后端-用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台的童工接口，而在底层使用操作系统的用户界面方法。
6.	javascript解释器-用于解析和执行javascript代码
7.	数据存储-这是持久层。浏览器需要在硬盘上保存各种数据，例如cookie。

新的HTML规范（HTML5）定义了“网络数据库”，这是一个完整的浏览器内部数据库。

图为----浏览器的主要部件

![](/img/1.png)

值得注意的是，和大多数浏览器不同，Chrome浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。

## 呈现引擎

呈现引擎的作用：当然是“呈现”，也就是在浏览器的屏幕上显示请求的内容。

默认情况下，呈现引擎可显示HTML和XML文档与图片。通过插件（或浏览器扩展程序），还可以显示其他类型的内容；例如，使用PDF查看器就能显示PSF文档。但是在本章中，我们将集中介绍其主要用途：显示使用CSS格式化的HTML内容和图片。

## 呈现引擎

本文所讨论的浏览器（Firefox、Chrome浏览器和Safari）是基于两种呈现引擎构建的。Firefox使用的Gecko，这是Mozilla公司“自制”的呈现引擎。而Safari和Chrome浏览器使用的都是webkit。

Webkit是一种开放源代码呈现引擎，起初用于Linux品台，随后由Apple公司进行修改，从而支持苹果机和Windows。有关详情，请参阅[webkit.org](https://webkit.org/)

## 主流程

呈现引擎一开始会从网络层获取请求文档的内容，内容的大小一般限制在8000个块以内。

然后进行如下所示的基本流程：

![](/img/2.png)

呈现引擎将开始解析HTML文档，并将各个标记逐个穿化成“内容树”上的DOM节点。同事也会解析外部CSS文件以及样式元素中的样式数据。HTML中这些带有视觉指令的样式信息将用于创建另一个树结构：`呈现树`。

呈现树包含多个带有视觉属性（如颜色和尺寸）的矩形。这些矩形的排列顺序就是它们将在屏幕上显示的顺序。

呈现树构建完毕之后，进入`布局`处理阶段，也就是为每个节点分配一个应出现在屏幕上的确切坐标。下一个阶段是`绘制`-呈现引擎会遍历呈现树，有用户界面后端层将每个节点绘制出来。

需要着重支出的是，这是一个渐进的过程。为达到更好的用户体验，呈现引擎会力求尽快将内容显示在屏幕上。它不必等到整个HTML文档解析完毕之后，就会开始构建呈现树和设置布局。在不断接受和处理来自网络的奇遇内容的同事，呈现引擎会将部分内容解析并显示出来。

#### 主要流程

![](/img/3.png)
Webkit主流程

![](/img/4.jpg)
Mozilla的Decko呈现引擎主流程

从图3和图4可以看出，虽然webkit和decko使用的术语略有不同，但整体流程是基本相同。

Gecko将视觉格式化元素组成的树称为“框架树”。每个元素都是一个框架。webkit使用的术语是“呈现树”，它由“呈现对象”组成。对于元素的防治，webkit使用的术语是“布局”，而gecko称之为“重排”。对于连接DOM节点和可视化信息从创建呈现书的过程，webkit使用的术语是“附加”。有一个细微的非语义差别，就是Gecko在HTML与DOM树之间还有一个称为“内容槽”的层，用于生成DOM元素。我们会逐一论述流程中的每一部分：

## 解析-综述

解析是呈现引擎中非常重要的一个环节，因此我们要更深入地讲解。首先，来介绍一下解析。

解析文档是指将文档转化成为有意义的结构，也就是可让代码理解和使用的结构。解析得到的结果通常是代表了文档结构的节点树，它称作解析树或者语法树。

示例-解析`2 + 3 - 1`这个表达式，会返回下面的树：

![](img/5.png)
数学表达式树节点

## 语法

解析是以文档所遵循的语法规则（编写文档所有的语言或格式）为基础。所有可以解析的格式都必须对应确定的语法（由词汇和语法规则构成）。这称为[与上下文的语法](https://en.wikipedia.org/wiki/Context-free_grammar)。人类语言并不属于这样的语言，因此无法用常规的解析技术进行解析。

## 解析器和语法分析器的组合

解析的过程可以分成两个子过程：语法分析和词法分析

词法分析是将输入内容分割成大量标记的过程。标记是语言中的词汇，级构成内容的单位。在人类语言中，它相当于语言字典中的单词。

语法分析是应用语言的语法规则的过程。

解析器通常将解析工作分给一下两个组件：`词法分析器`（有时也称为标记生成器），负责将输入内容分解成一个个有效标记；而`解析器`负责根据语言的语法规则分析文档的结构，从而构建解析树。词法分析器知道如何将无关的字符（比如空格和换行符）分离出来。

![](img/6.png)
图：从源文档到解析树

解析是一个迭代的过程。通常，解析器回想词法分析器请求一个新标记，并尝试将其与某条语法规则进行匹配。如果发生了匹配规则，解析器会将一个对应于该标记的节点添加到解析树中，然后继续请求下一个标记。

如果没有规则可以匹配，解析器就会将标记存储到内部，并继续请求标记，知道找到可与所有内部存储匹配的标记匹配规则。如果找不到任何匹配规则，解析器就会引发一个异常。这意味着文档无效，包含语法错误。

## 翻译

很多时候，解析树还不是最终产品。解析通常是在翻译过程中使用，而翻译是指将输入文档转换成另一种格式。变异就是这样一个例子。编译器可将源代码变异成机器代码，具体过程是首先将源代码解析成解析树，然后将解析树翻译成机器代码文档。

![](img/7.png)

## 解析示例

在图5中，我们通过一个数学表达式建立了解析树。现在，让我们试着定义一个简单的数学语言，用来演示解析的过程。

词汇：我们用的语言可包含整数、加号和减号。

语法：

1.	构成语言的语法单位是表达式，项和运算符
2.	我们用的语言可以包含任意数量的表达式
3.	表达式的定义是：一个“项”接一个“运算符”，然后再接一个“项”
4.	运算符是加号或减号
5.	项是一个整数或一个表达式

让我们分析一下`2 + 3 -1`。

匹配语法规则的第一个子串`2`，根据第五条无法规则，这是一个项。匹配语法规则的第二个子串是`2 + 3`，而根据第三条规则（一个项接一个运算符，然后接一个项），这是一个表达式。下一个匹配已经到了输入结束。`2 + 3 -1`是一个表达式，因为我们已经知道 `2　＋　3`是一个项，这样就符合“一个项接一个运算符”，然后再接一个项的规则，`2 + +`不与任何规则匹配，因此是无效的输入。






[https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#1_1](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#1_1)












## 未完待续...