浏览器的工作原理：新式网络浏览器幕后揭秘
===================================

## 序言

这是一篇全面介绍Webkit和Gecko内部操作的入门文章，是以色列开发人员塔利·加希尔大量研究的成果。在过去的几年中，她查阅了所有公开发布的关于浏览器内部机制的数据（详见[资料](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#Resources)），并花了很多时间来研读网络浏览器的源代码。她写道：

> 在IE占据90%市场份额的年代，我们除了把浏览器当成一个“黑箱”，什么也做不了。但是现在，开放源代码的浏览器拥有了过半的市场份额，因此，是时候来揭开神秘的面纱，一谈网络浏览器的内幕了。额，里面只有数以百万计的C++代码...

塔利在她的[网站](http://taligarsiel.com/)上公布了自己的研究成果，但是我们觉得它值得让更多的人来了解，所以我们在此重新整理并公布。

作为一名网络开发人员，学习浏览器的内部功罪原理将有助于您做出更明智的决策，并理解那些最佳开发时间的个中缘由。尽管这是一篇相当长的文档，但是我们建议您花些事件来仔细阅读；读完之后，您肯定会觉得所费不虚。

## 简洁

网络浏览器很可能是使用最广的软件。在这篇入门文章中，我将会介绍他们的幕后工作原理。我们会了解到，从您在地址栏输入google.com直到您在浏览器屏幕上看到Google首页的整个过程中都发生了什么。

## 我们要讨论的浏览器

目前使用的主流浏览器有五个：Internet Explorer、 Firefox、 Safari、 Chrome浏览器和Opera。本文中以开放源代码浏览器为例，目前Firefox、 Chrome浏览器和Safari（部分开源）。根据[StatCounter浏览器统计数据](http://gs.statcounter.com/)，目前Firefox、 Safari和Chrome浏览器的总市场占有率将近60%。由此可见，如今开放源代码浏览器在浏览器市场中战绝非常监事的部分。

## 浏览器的主要功能

浏览器的主要功能就是向服务器发送请求，在浏览器窗口中展示您选择的网络资源。这里所说的资源一般是指HTML文档，也可以是PDF、图片或其他的类型。资源的位置由用户的URL（统一资源标识符）指定。

浏览器解释并显示HTML文档的方式是在HTML和CSS规范中指定的。这些规范由网络标准化组织`W3C`（万维网联盟）进行维护。

多年以来，各个浏览器都没有完全遵循这些规范，同时还在开发自己独有的扩展程序，这给昂罗开发人员带来了严重的兼容性问题。如今，大多数浏览器都算是或多或少地遵从规范。

浏览器的用户界面有很多彼此相同的元素，其中包括：

*	用来输入URL的地址栏
*	前进和后退按钮
*	数钱设置选项
*	用于刷新和停止加载当前文档的刷新和停止按钮
*	用于返回主页的主页按钮

奇怪的是，浏览的用户界面并没有任何真实规范，这是多年的最佳实践自然发展以及批次之间相互模仿的结果。HTML5也没有定义浏览器必须具备的用户界面元素，但列出了一些通用的元素，例如地址栏，状态栏和工具栏等。当然，各个浏览器也可以有自己独特的功能，比如Firefox的下载管理器。

## 浏览器的高层结构

浏览器的主要组件为：

1.	用户界面-包括地址栏、前进、后退按钮，数钱菜单等。除了浏览器主窗口显示您请求的页面外，其他显示的各个部分都属于用户界面。
2.	浏览器殷勤-用户界面和呈现引擎之间传送命令。
3.	呈现引擎-负责显示请求的内容。如果请求的内容是HTML，它就负责解析HTML和CSS内容，并将解析后的内容显示在屏幕上。
4.	网络-用户网络调用，比如http请求。其接口与平台无关，并为所有平台提供底层实现。
5.	用户界面后端-用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台的童工接口，而在底层使用操作系统的用户界面方法。
6.	javascript解释器-用于解析和执行javascript代码
7.	数据存储-这是持久层。浏览器需要在硬盘上保存各种数据，例如cookie。

新的HTML规范（HTML5）定义了“网络数据库”，这是一个完整的浏览器内部数据库。

图为----浏览器的主要部件

![](/img/1.png)

值得注意的是，和大多数浏览器不同，Chrome浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。

## 呈现引擎

呈现引擎的作用：当然是“呈现”，也就是在浏览器的屏幕上显示请求的内容。

默认情况下，呈现引擎可显示HTML和XML文档与图片。通过插件（或浏览器扩展程序），还可以显示其他类型的内容；例如，使用PDF查看器就能显示PSF文档。但是在本章中，我们将集中介绍其主要用途：显示使用CSS格式化的HTML内容和图片。

## 呈现引擎

本文所讨论的浏览器（Firefox、Chrome浏览器和Safari）是基于两种呈现引擎构建的。Firefox使用的Gecko，这是Mozilla公司“自制”的呈现引擎。而Safari和Chrome浏览器使用的都是webkit。

Webkit是一种开放源代码呈现引擎，起初用于Linux品台，随后由Apple公司进行修改，从而支持苹果机和Windows。有关详情，请参阅[webkit.org](https://webkit.org/)

## 主流程

呈现引擎一开始会从网络层获取请求文档的内容，内容的大小一般限制在8000个块以内。

然后进行如下所示的基本流程：

![](/img/2.png)

呈现引擎将开始解析HTML文档，并将各个标记逐个穿化成“内容树”上的DOM节点。同事也会解析外部CSS文件以及样式元素中的样式数据。HTML中这些带有视觉指令的样式信息将用于创建另一个树结构：`呈现树`。

呈现树包含多个带有视觉属性（如颜色和尺寸）的矩形。这些矩形的排列顺序就是它们将在屏幕上显示的顺序。

呈现树构建完毕之后，进入`布局`处理阶段，也就是为每个节点分配一个应出现在屏幕上的确切坐标。下一个阶段是`绘制`-呈现引擎会遍历呈现树，有用户界面后端层将每个节点绘制出来。

需要着重支出的是，这是一个渐进的过程。为达到更好的用户体验，呈现引擎会力求尽快将内容显示在屏幕上。它不必等到整个HTML文档解析完毕之后，就会开始构建呈现树和设置布局。在不断接受和处理来自网络的奇遇内容的同事，呈现引擎会将部分内容解析并显示出来。

#### 主要流程

![](/img/3.png)
Webkit主流程

![](/img/4.png)
Mozilla的Decko呈现引擎主流程

[https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#1_1](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#1_1)












## 未完待续...